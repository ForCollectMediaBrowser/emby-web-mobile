define(['paperdialoghelper','jQuery','paper-fab'],function(paperDialogHelper,$){var currentItemId;var currentFile;var currentDeferred;var hasChanges=false;function onFileReaderError(evt){Dashboard.hideLoadingMsg();switch(evt.target.error.code){case evt.target.error.NOT_FOUND_ERR:require(['toast'],function(toast){toast(Globalize.translate('MessageFileNotFound'));});break;case evt.target.error.ABORT_ERR:break;default:require(['toast'],function(toast){toast(Globalize.translate('MessageFileReadError'));});break;};}
function setFiles(page,files){var file=files[0];if(!file||!file.type.match('image.*')){$('#imageOutput',page).html('');$('#fldUpload',page).hide();currentFile=null;return;}
currentFile=file;var reader=new FileReader();reader.onerror=onFileReaderError;reader.onloadstart=function(){$('#fldUpload',page).hide();};reader.onabort=function(){Dashboard.hideLoadingMsg();console.log('File read cancelled');};reader.onload=(function(theFile){return function(e){var html=['<img style="max-width:300px;max-height:100px;" src="',e.target.result,'" title="',escape(theFile.name),'"/>'].join('');$('#imageOutput',page).html(html);$('#fldUpload',page).show();};})(file);reader.readAsDataURL(file);}
function processImageChangeResult(page){hasChanges=true;history.back();}
function onSubmit(){var file=currentFile;if(!file){return false;}
if(file.type!="image/png"&&file.type!="image/jpeg"&&file.type!="image/jpeg"){return false;}
Dashboard.showLoadingMsg();var page=$(this).parents('dialog');var imageType=$('#selectImageType',page).val();ApiClient.uploadItemImage(currentItemId,imageType,file).then(function(){$('#uploadImage',page).val('').trigger('change');Dashboard.hideLoadingMsg();processImageChangeResult(page);});return false;}
function initEditor(page){$('form',page).off('submit',onSubmit).on('submit',onSubmit);$('#uploadImage',page).on("change",function(){setFiles(page,this.files);});$("#imageDropZone",page).on('dragover',function(e){e.preventDefault();e.originalEvent.dataTransfer.dropEffect='Copy';return false;}).on('drop',function(e){e.preventDefault();setFiles(page,e.originalEvent.dataTransfer.files);return false;});}
function showEditor(itemId,options){options=options||{};var xhr=new XMLHttpRequest();xhr.open('GET','components/imageuploader/imageuploader.template.html',true);xhr.onload=function(e){var template=this.response;currentItemId=itemId;var dlg=paperDialogHelper.createDialog({size:'fullscreen-border'});var theme=options.theme||'b';dlg.classList.add('ui-body-'+theme);dlg.classList.add('background-theme-'+theme);dlg.classList.add('popupEditor');var html='';html+='<h2 class="dialogHeader">';html+='<paper-fab icon="arrow-back" mini class="btnCloseDialog" tabindex="-1"></paper-fab>';html+='<div style="display:inline-block;margin-left:.6em;vertical-align:middle;">'+Globalize.translate('HeaderUploadImage')+'</div>';html+='</h2>';html+='<div class="editorContent">';html+=Globalize.translateDocument(template);html+='</div>';dlg.innerHTML=html;document.body.appendChild(dlg);$(dlg).on('close',onDialogClosed);paperDialogHelper.open(dlg);var editorContent=dlg.querySelector('.editorContent');initEditor(editorContent);$('#selectImageType',dlg).val(options.imageType||'Primary');$('.btnCloseDialog',dlg).on('click',function(){paperDialogHelper.close(dlg);});}
xhr.send();}
function onDialogClosed(){$(this).remove();Dashboard.hideLoadingMsg();currentDeferred.resolveWith(null,[hasChanges]);}
return{show:function(itemId,options){var deferred=jQuery.Deferred();currentDeferred=deferred;hasChanges=false;showEditor(itemId,options);return deferred.promise();}};});